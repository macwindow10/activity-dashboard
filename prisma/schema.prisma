generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                  @id @default(cuid())
  email                 String                  @unique
  name                  String?
  hashedPassword        String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  role                  String?                 @db.NVarChar(50)
  activities            Activity[]
  activityPersons       ActivityPerson[]
  activityStatusChanges ActivityStatusHistory[]
  projectsOwned         Project[]
  projectsAssigned      ProjectAssignee[]
}

model Project {
  id          String            @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  activities  ActivityProject[]
  owner       User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  assignees   ProjectAssignee[]

  @@index([ownerId])
}

model ProjectAssignee {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onUpdate: NoAction)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Activity {
  id              String                  @id @default(cuid())
  description     String
  type            String
  status          String                  @default("Created")
  dueDate         DateTime
  completionDate  DateTime?
  createdById     String
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  createdBy       User                    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  assignedPersons ActivityPerson[]
  projects        ActivityProject[]
  statusHistory   ActivityStatusHistory[]

  @@index([createdById])
  @@index([dueDate])
  @@index([status])
}

model ActivityStatusHistory {
  id          String   @id @default(cuid())
  activityId  String
  status      String
  remarks     String?
  changedById String
  changedAt   DateTime @default(now())
  activity    Activity @relation(fields: [activityId], references: [id], onUpdate: NoAction)
  changedBy   User     @relation(fields: [changedById], references: [id])

  @@index([activityId])
  @@index([changedById])
  @@index([status])
  @@index([changedAt])
}

model ActivityProject {
  id         String   @id @default(cuid())
  activityId String
  projectId  String
  activity   Activity @relation(fields: [activityId], references: [id], onUpdate: NoAction)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([activityId, projectId])
  @@index([activityId])
  @@index([projectId])
}

model ActivityPerson {
  id         String   @id @default(cuid())
  activityId String
  userId     String
  activity   Activity @relation(fields: [activityId], references: [id], onUpdate: NoAction)
  user       User     @relation(fields: [userId], references: [id])

  @@unique([activityId, userId])
  @@index([activityId])
  @@index([userId])
}
